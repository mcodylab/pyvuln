trigger:
- main  # Se ejecuta en cada cambio en main

pr:
- main  # También se ejecuta en cada Pull Request a main

pool:
  vmImage: 'ubuntu-latest'  # Máquina virtual para ejecutar el pipeline

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:
- checkout: self  # Clona el repositorio de GitHub en la máquina virtual

- script: |
    echo "Instalando Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
    node -v  # Verifica la instalación
  displayName: 'Instalar Node.js'

- script: |
    echo "Instalando Snyk..."
    npm install -g snyk  # Instala Snyk CLI

    echo "Autenticando con Snyk..."
    snyk auth $(SNYK_TOKEN)  # Usa el token secreto

    echo "Ejecutando escaneo de seguridad..."
    snyk test --severity-threshold=high  # Falla si encuentra vulnerabilidades críticas
  displayName: 'Run Snyk Security Scan'

- script: |
    echo "Enviando reporte a Snyk Dashboard..."
    snyk monitor  # Guarda el reporte en app.snyk.io para seguimiento
  displayName: 'Upload results to Snyk'
