trigger:
- main  # O el branch donde quieres ejecutarlo

pool:
   name: 'Agent'

variables:
  - group: varcody    # Contiene la variable SNYK_TOKEN

steps:
- checkout: self 


- script: chmod +x $(Build.SourcesDirectory) -R
  displayName: 'Dar permisos a los archivos'

# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ğŸ“‚ Directorio actual:"
    pwd
    echo "ğŸ“‚ Archivos disponibles:"
    ls -lhR $(Build.SourcesDirectory)
  displayName: 'ğŸ“‚ Verificar entorno antes de Snyk'


# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ğŸ“‚ Pip freeze:"
     pip freeze > requirements.txt
    echo "ğŸ“‚ Validacion:"
    pip check
  displayName: 'ğŸ“‚ Validaciones requirements - validaciones '


# 2ï¸âƒ£ Instalar Snyk CLI si no estÃ¡ disponible






# 3ï¸âƒ£ Autenticar con Snyk Web
- script: |
    echo "ğŸ”‘ Autenticando Snyk..."
    snyk auth $(SNYK_TOKEN)
  displayName: 'ğŸ”‘ AutenticaciÃ³n en Snyk'

# 4ï¸âƒ£ Ejecutar anÃ¡lisis de seguridad en cÃ³digo fuente
- script: |
    echo "ğŸ” Ejecutando Snyk Test..."
    snyk auth $(SNYK_TOKEN)
    snyk test --project-name="$(Build.Repository.Name)" --json-file-output=$(Build.SourcesDirectory)/snyk-code-report.json || echo "âš ï¸ Error en Snyk Test"
    snyk monitor --project-name="$(Build.Repository.Name)" || echo "âš ï¸ Error al enviar datos a Snyk Web"
  displayName: 'ğŸ” Ejecutar Snyk Test'

# 7ï¸âƒ£ Enviar resultados a Snyk Web
- script: |
    echo "ğŸ“¡ Enviando datos a Snyk Web..."
    snyk monitor --project-name="$(Build.Repository.Name)" || echo "âš ï¸ Error al enviar datos a Snyk Web"
  displayName: 'ğŸ“¡ Enviar datos a Snyk Web'








# ğŸ“‚ Verificar archivos en Build.SourcesDirectory
- script: |
    echo "ğŸ“‚ Contenido de Build.SourcesDirectory despuÃ©s de conversiÃ³n:"
    ls -l $(Build.SourcesDirectory)
  displayName: "Verificar archivos en Build.SourcesDirectory"


# 3ï¸âƒ£ Convertir JSON a HTML con formato
- script: |
    echo "ğŸ”„ Convirtiendo JSON a HTML..."
    echo "<html><head><title>Snyk Report</title><style>table {width: 100%; border-collapse: collapse;} th, td {border: 1px solid black; padding: 8px; text-align: left;} th {background-color: #f2f2f2;}</style></head><body><h1>Resultados de AnÃ¡lisis</h1><table><tr><th>ID</th><th>Severidad</th><th>Paquete</th><th>Vulnerabilidad</th><th>CVSS</th><th>MÃ¡s InformaciÃ³n</th></tr>" > $(Build.ArtifactStagingDirectory)/snyk-report.html
    cat $(Build.SourcesDirectory)/snyk-code-report.json | jq -r '
    .vulnerabilities[] | 
    "<tr><td>\(.id)</td><td>\(.severity)</td><td>\(.moduleName)</td><td>\(.title)</td><td>\(.cvssScore)</td><td><a href=\"\(.references[0].url)\">Detalles</a></td></tr>"' >> $(Build.ArtifactStagingDirectory)/snyk-report.html
    echo "</table></body></html>" >> $(Build.ArtifactStagingDirectory)/snyk-report.html
  displayName: "ğŸ”„ Convertir JSON a HTML"

# 4ï¸âƒ£ Verificar que los archivos se generaron en ArtifactStagingDirectory
- script: |
    echo "ğŸ“‚ Contenido de Build.ArtifactStagingDirectory despuÃ©s de conversiÃ³n:"
    ls -l $(Build.ArtifactStagingDirectory)
  displayName: "ğŸ“‚ Verificar archivos en ArtifactStagingDirectory"

# 5ï¸âƒ£ Publicar el JSON y el HTML como artefactos
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/snyk-code-report.json'
    artifactName: 'snyk-json-report'
  displayName: 'ğŸ“¤ Publicar Reporte JSON de Snyk'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/snyk-report.html'
    artifactName: 'snyk-html-report'
  displayName: 'ğŸ“¤ Publicar Reporte HTML de Snyk'

# 6ï¸âƒ£ Intentar mostrar el reporte en la pestaÃ±a de Code Coverage
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(Build.ArtifactStagingDirectory)/snyk-report.html'
    reportDirectory: '$(Build.ArtifactStagingDirectory)/'
  displayName: 'ğŸ“¤ Publicar Reporte como Code Coverage'