trigger:
- main  # O el branch donde quieres ejecutarlo

pool:
   name: 'Agent'

variables:
  - group: varcody    # Contiene la variable SNYK_TOKEN

steps:
- checkout: self 


- script: chmod +x $(Build.SourcesDirectory) -R
  displayName: 'Dar permisos a los archivos'

# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ğŸ“‚ Directorio actual:"
    pwd
    echo "ğŸ“‚ Archivos disponibles:"
    ls -lhR $(Build.SourcesDirectory)
  displayName: 'ğŸ“‚ Verificar entorno antes de Snyk'

# 2ï¸âƒ£ Instalar Snyk CLI si no estÃ¡ disponible




- task: SnykSecurityScan@1
  inputs:
    serviceConnectionEndpoint: 'snykcon'
    testType: 'code'
    failOnIssues: true



# 3ï¸âƒ£ Autenticar con Snyk Web
- script: |
    echo "ğŸ”‘ Autenticando Snyk..."
    snyk auth $(SNYK_TOKEN)
  displayName: 'ğŸ”‘ AutenticaciÃ³n en Snyk'



# 8ï¸âƒ£ Publicar reportes de Snyk en Azure DevOps
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.SourcesDirectory)/snyk-code-report.json'
    artifactName: 'snyk-code-report'
  displayName: 'ğŸ“„ Publicar Reporte Snyk Code'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.SourcesDirectory)/snyk-deps-report.json'
    artifactName: 'snyk-deps-report'
  displayName: 'ğŸ“„ Publicar Reporte Snyk Dependencies'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.SourcesDirectory)/snyk-docker-report.json'
    artifactName: 'snyk-docker-report'
  displayName: 'ğŸ“„ Publicar Reporte Snyk Docker'
  condition: succeededOrFailed() # Evita fallar si no hay Docker
