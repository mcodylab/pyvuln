trigger:
- main  # Se ejecuta en cada cambio en main

pr:
- main  # También se ejecuta en cada Pull Request a main

pool:
  vmImage: 'ubuntu-latest'  # Máquina virtual para ejecutar el pipeline

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:

  - script: |
      pip install --no-cache-dir --index-url https://pypi.org/simple --upgrade pip  # Actualiza pip
      pip install --no-cache-dir --index-url https://pypi.org/simple  -r requirements.txt  # Instala dependencias
      npm install -g snyk  # Instala Snyk CLI
      snyk auth $(SNYK_TOKEN)  # Autentica con Snyk
      snyk code test --debug || true
      snyk container test --file=Dockerfile || true
      snyk test --all-projects --severity-threshold=low || true
      snyk test --all-projects --severity-threshold=low --json > $(Build.ArtifactStagingDirectory)/snyk-report.json
      snyk monitor
    displayName: 'Forzar salida JSON'
    
  - script: |
      snyk monitor
    displayName: '📡 Enviar datos a Snyk Web'

  - task: SnykSecurityScan@1
    inputs:
      serviceConnectionEndpoint: 'snykcon'
      testType: 'app'
      monitorWhen: 'never'  # Deshabilita `snyk monitor` aquí para evitar el error
      failOnIssues: false


  


  - script: |
      echo "📂 Listando archivos en $(Build.ArtifactStagingDirectory):"
      ls -lh $(Build.ArtifactStagingDirectory)

      echo "📄 Mostrando contenido de snyk-report.json:"
      cat $(Build.ArtifactStagingDirectory)/snyk-report.json || echo "⚠️ No se encontró snyk-report.json"

    displayName: '🔍 Verificar reporte JSON'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/snyk-report.json'                                                                                                                                                                          
      artifactName: 'snyk-security-report'