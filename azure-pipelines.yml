trigger:
- main  # O el branch donde quieres ejecutarlo

pool:
   name: 'Agent'

variables:
  - group: varcody    # Contiene la variable SNYK_TOKEN

steps:
- checkout: self 


- script: chmod +x $(Build.SourcesDirectory) -R
  displayName: 'Dar permisos a los archivos'

# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ğŸ“‚ Directorio actual:"
    pwd
    echo "ğŸ“‚ Archivos disponibles:"
    ls -lhR $(Build.SourcesDirectory)
  displayName: 'ğŸ“‚ Verificar entorno antes de Snyk'


# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ğŸ“‚ Pip freeze:"
     pip freeze > requirements.txt
    echo "ğŸ“‚ Validacion:"
    pip check
  displayName: 'ğŸ“‚ Validaciones requirements - validaciones '


# 2ï¸âƒ£ Instalar Snyk CLI si no estÃ¡ disponible






# 3ï¸âƒ£ Autenticar con Snyk Web
- script: |
    echo "ğŸ”‘ Autenticando Snyk..."
    snyk auth $(SNYK_TOKEN)
  displayName: 'ğŸ”‘ AutenticaciÃ³n en Snyk'


# 4ï¸âƒ£ Ejecutar anÃ¡lisis de seguridad en cÃ³digo fuente
- script: |
    echo "ğŸ” Ejecutando Snyk Test..."
    snyk auth $(SNYK_TOKEN)
    snyk   test    --project-name="$(Build.Repository.Name)" --json-file-output=$(Build.SourcesDirectory)/snyk-code-report.json  || echo "âš ï¸ Error en Snyk Test"
    snyk monitor --project-name="$(Build.Repository.Name)"   || echo "âš ï¸ Error al enviar datos a Snyk Web"
  displayName: 'ğŸ” Ejecutar Snyk Test'

# ğŸ”¹ Verificar que el JSON tiene datos antes de publicarlo
- script: |
    if [ ! -s "$(Build.SourcesDirectory)/snyk-code-report.json" ]; then
      echo "âš ï¸ El archivo JSON de Snyk estÃ¡ vacÃ­o o no se generÃ³ correctamente."
      exit 1
    fi
    echo "âœ… Reporte de Snyk generado correctamente:"
    cat $(Build.SourcesDirectory)/snyk-code-report.json
  displayName: 'ğŸ“„ Verificar contenido del reporte Snyk'


# ğŸ”¹ ğŸ“¢ Mostrar resumen del reporte en el log del pipeline
- script: |
    echo "ğŸ“¢ Resumen del reporte Snyk:"
    jq '.vulnerabilities[] | {id, package, version, severity, title}' $(Build.SourcesDirectory)/snyk-code-report.json
  displayName: 'ğŸ“¢ Mostrar resumen en el pipeline'

# ğŸ”¹ Convertir JSON a Markdown (para mostrarlo en el resumen)
- script: |
    echo "| ID | Paquete | VersiÃ³n | Severidad | TÃ­tulo |" > $(Build.SourcesDirectory)/snyk-summary.md
    echo "|----|---------|---------|-----------|--------|" >> $(Build.SourcesDirectory)/snyk-summary.md
    jq -r '.vulnerabilities[] | "| \(.id) | \(.package) | \(.version) | \(.severity) | \(.title) |"' $(Build.SourcesDirectory)/snyk-code-report.json >> $(Build.SourcesDirectory)/snyk-summary.md
  displayName: "ğŸ“ Convertir JSON a Markdown"

# ğŸ”¹ Publicar Markdown como resumen del pipeline
- task: PublishBuildArtifacts@1
  inputs:
    path: '$(Build.SourcesDirectory)/snyk-summary.md'
    artifactName: 'snyk-summary'
  displayName: 'ğŸ“„ Publicar resumen de Snyk'

# ğŸ”¹ Publicar reporte JSON en Azure DevOps
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.SourcesDirectory)/snyk-code-report.json'
    artifactName: 'snyk-code-report'
  displayName: 'ğŸ“„ Publicar Reporte Snyk Code'

# 7ï¸âƒ£ Enviar resultados a Snyk Web
- script: |
    echo "ğŸ“¡ Enviando datos a Snyk Web..."
    snyk monitor --project-name="$(Build.Repository.Name)"   || echo "âš ï¸ Error al enviar datos a Snyk Web"
  displayName: 'ğŸ“¡ Enviar datos a Snyk Web'

# ğŸ”¹ Verificar archivos generados
- script: |
    echo "ğŸ“‚ Archivos generados en el directorio:"
    ls -lh $(Build.SourcesDirectory)
  displayName: "ğŸ“‚ Verificar archivos generados"