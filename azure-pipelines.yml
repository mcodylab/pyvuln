trigger:
- main  # O el branch donde quieres ejecutarlo

pool:
   name: 'Agent'

variables:
  - group: varcody    # Contiene la variable SNYK_TOKEN

steps:
- checkout: self 


- script: chmod +x $(Build.SourcesDirectory) -R
  displayName: 'Dar permisos a los archivos'

# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ðŸ“‚ Directorio actual:"
    pwd
    echo "ðŸ“‚ Archivos disponibles:"
    ls -lhR $(Build.SourcesDirectory)
  displayName: 'ðŸ“‚ Verificar entorno antes de Snyk'


# 1ï¸âƒ£ Verifica el entorno del pipeline
- script: |
    echo "ðŸ“‚ Pip freeze:"
     pip freeze > requirements.txt
    echo "ðŸ“‚ Validacion:"
    pip check
  displayName: 'ðŸ“‚ Validaciones requirements - validaciones '


# 2ï¸âƒ£ Instalar Snyk CLI si no estÃ¡ disponible






# 3ï¸âƒ£ Autenticar con Snyk Web
- script: |
    echo "ðŸ”‘ Autenticando Snyk..."
    snyk auth $(SNYK_TOKEN)
  displayName: 'ðŸ”‘ AutenticaciÃ³n en Snyk'

# 4ï¸âƒ£ Ejecutar anÃ¡lisis de seguridad en cÃ³digo fuente
- script: |
    echo "ðŸ” Ejecutando Snyk Test..."
    snyk auth $(SNYK_TOKEN)
    snyk test --project-name="$(Build.Repository.Name)" --json-file-output=$(Build.SourcesDirectory)/snyk-code-report.json || echo "âš ï¸ Error en Snyk Test"
    snyk monitor --project-name="$(Build.Repository.Name)" || echo "âš ï¸ Error al enviar datos a Snyk Web"
  displayName: 'ðŸ” Ejecutar Snyk Test'


# 2ï¸âƒ£ Verificar que el JSON se generÃ³ correctamente
- script: |
    echo "ðŸ“‚ Verificando que Snyk generÃ³ el reporte JSON..."
    ls -l $(Build.SourcesDirectory)
  displayName: "ðŸ“‚ Verificar archivos generados por Snyk"

# 3ï¸âƒ£ Mover JSON a ArtifactStagingDirectory
- script: |
    echo "ðŸš€ Moviendo JSON a ArtifactStagingDirectory..."
    mv $(Build.SourcesDirectory)/snyk-code-report.json $(Build.ArtifactStagingDirectory)/
  displayName: "ðŸ“‚ Mover JSON a ArtifactStagingDirectory"

# 4ï¸âƒ£ Convertir JSON a Markdown para la pestaÃ±a Summary
- script: |
    echo "ðŸ”„ Convirtiendo JSON a Markdown..."
    echo "# Snyk Report" > $(Build.ArtifactStagingDirectory)/snyk-report.md
    echo "### Vulnerabilidades Encontradas" >> $(Build.ArtifactStagingDirectory)/snyk-report.md
    cat $(Build.ArtifactStagingDirectory)/snyk-code-report.json | jq -r '
    .vulnerabilities[] | 
    "#### \(.id)\n- **Severidad:** \(.severity)\n- **Paquete:** \(.moduleName)\n- **Vulnerabilidad:** \(.title)\n- **CVSS Score:** \(.cvssScore)\n- [Detalles](\(.references[0].url))\n"' >> $(Build.ArtifactStagingDirectory)/snyk-report.md
  displayName: "ðŸ”„ Convertir JSON a Markdown"

# 5ï¸âƒ£ Publicar Reporte Markdown en Summary
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/snyk-report.md'
    artifactName: 'snyk-markdown-report'
  displayName: 'ðŸ“¤ Publicar Reporte Markdown'

# 6ï¸âƒ£ Publicar Markdown como Summary
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo "## Snyk Report" > $(Build.ArtifactStagingDirectory)/snyk-summary.md
      Get-Content -Path "$(Build.ArtifactStagingDirectory)/snyk-report.md" | Out-File -FilePath "$(Build.ArtifactStagingDirectory)/snyk-summary.md" -Append
  displayName: "Generar Summary"
  condition: succeeded()

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/snyk-summary.md'
    artifactName: 'snyk-summary'
  displayName: 'ðŸ“¤ Publicar Summary'

- task: PublishBuildArtifacts@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'snyk-reports'
  displayName: 'Publicar todos los reportes'